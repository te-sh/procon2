---
title: "ARC #070 E"
problem: https://atcoder.jp/contests/arc070/tasks/arc070_c
---
上から $$ i $$ 個までの長方形を動かしたところで, $$ i $$ 個目の長方形の左端の座標を $$ x $$ に動かしたときの最小コストを $$ C(i, x) $$ とする.

このとき,

$$
C(i, x) = \vert x-l_i \vert + \min_{x-w_{i-1} \leq x^{\prime} \leq x+w_i} C(i-1, x^{\prime})
$$

となる. ただし, $$ w_i = r_i - l_i $$ である.

これをDPで解けば, $$ O(NX^2) $$ で計算できるので部分点が取れる.

さて, $$ C(i, x) $$ がどのような形をしているかを考察してみよう.

$$ C(1, x) $$ は $$ \vert x-l_1 \vert $$ なので, 普通の絶対値のグラフである.

$$ C(2, x) $$ は $$ \min $$ の部分は絶対値のグラフに傾き0の底ができたようなグラフになる. それに絶対値のグラフを加えるので, 傾きが-2, -1, 0, 1, 2と変わっていくグラフになる. (ただし, $$ l_2 $$ の位置によっては傾き-1, 0, 1の部分はない場合もある)

以下これを繰り返していくと, 傾きが整数ずつ変わっていくグラフになり, 最終的に傾き0の部分の値が最小値になる.

そこで, 傾きが1変わる部分のみを管理するようにする.

$$ C(1, x) $$ では, $$ l_1 $$ で傾きが $$ -1 $$ から $$ 1 $$ に変わるので, $$ l_1 $$ が2つになる. 傾き0の値は0である.

$$ C(2, x) $$ では, $$ \min $$ の部分で傾きが負の部分は左に $$ w_2 $$ だけずれ, 傾きが正の部分は右に $$ w_1 $$ だけずれる. よって $$ l_1-w_2, l_1+w_1 $$ となる.

そして絶対値を足す部分では, $$ l_2 $$ より左では傾きが1減り, $$ l_2 $$ より右では傾きが1増える.　よって, $$ l_1-w_2 \lt l_2 \lt l_1+w_1 $$ ならば $$ l_1-w_2, l_2, l_2, l_2+w_1 $$ となる. この場合は傾き0の値は変わらず0である. $$ l_2 \lt l_1-w_2 $$ ならば $$ l_2, l_2, l_1-w_2, l_1+w_1 $$ となる. 傾き0の値は $$ l_1-w_2-l_2 $$ に増える.

以下これを繰り返す.

傾きが変わる点を効率的に管理するために, 傾きが正と負で別々の赤黒木を用意する.

$$ \min $$ の部分でずれる量はオフセットとして別に計算し, 絶対値を足す部分では $$ l_i $$ の位置によって適切な方の赤黒木に $$ l_i $$ を2つ足すようにする. この結果, 片方の赤黒木からもう片方の赤黒木に値を移したりすることになる.
